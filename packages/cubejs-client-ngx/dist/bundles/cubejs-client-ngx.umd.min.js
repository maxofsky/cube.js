!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("rxjs"),require("@cubejs-client/core"),require("rxjs/operators"),require("fast-deep-equal")):"function"==typeof define&&define.amd?define("@cubejs-client/ngx",["exports","@angular/core","rxjs","@cubejs-client/core","rxjs/operators","fast-deep-equal"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self)["cubejs-client"]=e["cubejs-client"]||{},e["cubejs-client"].ngx={}),e.ng.core,e.rxjs,e.cubejs,e.rxjs.operators,e.equal)}(this,(function(e,t,r,i,n,s){"use strict";function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var u=o(i),a=o(s),c=function(e,t){return c=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},c(e,t)};function f(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}c(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}function l(e,t,r,i){return new(r||(r=Promise))((function(n,s){function o(e){try{a(i.next(e))}catch(e){s(e)}}function u(e){try{a(i.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,u)}a((i=i.apply(e,t||[])).next())}))}function h(e,t){var r,i,n,s,o={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return s={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function u(s){return function(u){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,i&&(n=2&s[0]?i.return:s[0]?i.throw||((n=i.return)&&n.call(i),0):i.next)&&!(n=n.call(i,s[1])).done)return n;switch(i=0,n&&(s=[2&s[0],n.value]),s[0]){case 0:case 1:n=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,i=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(n=o.trys,(n=n.length>0&&n[n.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!n||s[1]>n[0]&&s[1]<n[3])){o.label=s[1];break}if(6===s[0]&&o.label<n[1]){o.label=n[1],n=s;break}if(n&&o.label<n[2]){o.label=n[2],o.ops.push(s);break}n[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],i=0}finally{r=n=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,u])}}}Object.create;function p(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var i,n,s=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(i=s.next()).done;)o.push(i.value)}catch(e){n={error:e}}finally{try{i&&!i.done&&(r=s.return)&&r.call(s)}finally{if(n)throw n.error}}return o}function y(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(p(arguments[t]));return e}Object.create;var b=function(){function e(e){var t=this;this.config=e,this.ready$=new r.BehaviorSubject(!1),this.config instanceof r.Observable?this.config.subscribe((function(){t.ready$.next(!0)})):this.ready$.next(!0)}return e.prototype.apiInstace=function(){var e=this;return this.cubeJsApi||(this.config instanceof r.Observable?this.config.subscribe((function(t){if(e.cubeJsApi=u.default(t.token,t.options),!e.cubeJsApi)throw new Error("Cannot create CubejsApi instance. Please check that the config is passed correctly and contains all required options.")})):this.cubeJsApi=u.default(this.config.token,this.config.options)),this.cubeJsApi},e.prototype.load=function(e,t){return r.from(this.apiInstace().load(e,t))},e.prototype.sql=function(e,t){return r.from(this.apiInstace().sql(e,t))},e.prototype.dryRun=function(e,t){return r.from(this.apiInstace().dryRun(e,t))},e.prototype.meta=function(e){return r.from(this.apiInstace().meta(e))},e.prototype.watch=function(e,t){var i=this;return void 0===t&&(t={}),new r.Observable((function(r){return e.subscribe({next:function(e){return l(i,void 0,void 0,(function(){var i;return h(this,(function(n){switch(n.label){case 0:return[4,this.apiInstace().load(e,t)];case 1:return i=n.sent(),r.next(i),[2]}}))}))}})}))},e}();b.decorators=[{type:t.Injectable}],b.ctorParameters=function(){return[{type:void 0,decorators:[{type:t.Inject,args:["config"]}]}]};var m=function(){function e(){}return e.forRoot=function(t){return{ngModule:e,providers:[b,{provide:"config",useValue:t}]}},e}();m.decorators=[{type:t.NgModule,args:[{providers:[b]}]}];var d=function(){function e(e){this.subject=new r.BehaviorSubject(e)}return e.prototype.get=function(){return this.subject.getValue()},e.prototype.set=function(e){this.subject.next(e)},e}();var g=function(){function e(e,t){this.query=e,this.field=t}return Object.defineProperty(e.prototype,"members",{get:function(){return this.query.asCubeQuery()[this.field]||[]},enumerable:!1,configurable:!0}),e.prototype.add=function(e){var t;this.query.setPartialQuery(((t={})[this.field]=y(this.members,[e]),t))},e.prototype.replace=function(e,t){var r;this.query.setPartialQuery(((r={})[this.field]=this.members.map((function(r){return r===e?t:r})),r))},e.prototype.remove=function(e){var t;this.query.setPartialQuery(((t={})[this.field]=this.query.asCubeQuery()[this.field].filter((function(t,r){return"string"==typeof e?t!==e:r!==e})),t))},e.prototype.set=function(e){var t;this.query.setPartialQuery(((t={})[this.field]=e,t))},e.prototype.asArray=function(){var e=this;return(this.query.asCubeQuery()[this.field]||[]).map((function(t){return e.query.meta.resolveMember(t,e.field)}))},e}();var v=function(){function e(e){this.query=e}return Object.defineProperty(e.prototype,"members",{get:function(){return this.query.asCubeQuery().timeDimensions||[]},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"granularity",{get:function(){var e;return null===(e=this.members[0])||void 0===e?void 0:e.granularity},enumerable:!1,configurable:!0}),e.prototype.updateTimeDimension=function(e,t){var r=this.members.map((function(r,i){return r.dimension===e||i===e?Object.assign(Object.assign({},r),t):r}));this.query.setPartialQuery({timeDimensions:r})},e.prototype.add=function(e){this.query.setPartialQuery({timeDimensions:[{dimension:e}]})},e.prototype.remove=function(e){this.query.setPartialQuery({timeDimensions:this.members.filter((function(t){return t.dimension!==e}))})},e.prototype.set=function(e){this.query.setPartialQuery({timeDimensions:e})},e.prototype.setDateRange=function(e,t){this.updateTimeDimension(e,{dateRange:t})},e.prototype.setGranularity=function(e,t){this.updateTimeDimension(e,{granularity:t})},e.prototype.asArray=function(){var e=this;return(this.query.asCubeQuery().timeDimensions||[]).map((function(t){return Object.assign(Object.assign({},e.query.meta.resolveMember(t.dimension,"dimensions")),t)}))},e}();var j=function(){function e(e){this.query=e,this.orderMembers=new r.BehaviorSubject([]),this.query.subject.subscribe(this.handleQueryChange.bind(this)),this.orderMembers.subscribe(this.handleOrderMembersChange.bind(this))}return e.prototype.handleOrderMembersChange=function(e){var t=e.filter((function(e){return"none"!==e.order})).reduce((function(e,t){var r,i=t.id,n=t.order;return Object.assign(Object.assign({},e),((r={})[i]=n,r))}),{});a.default(t,this.asObject())||this.query.setPartialQuery({order:t})},e.prototype.handleQueryChange=function(){var e=this;this.orderMembers.next(y(this.query.measures.asArray(),this.query.dimensions.asArray(),this.query.timeDimensions.asArray()).map((function(t){var r=t.name,i=t.title;return{id:r,order:e.of(r),title:i}})))},e.prototype.setMemberOrder=function(e,t){this.orderMembers.next(this.orderMembers.getValue().map((function(r){return r.id===e?Object.assign(Object.assign({},r),{order:t}):r})))},e.prototype.reorder=function(e,t){this.orderMembers.next(i.moveItemInArray(this.orderMembers.getValue(),e,t))},e.prototype.of=function(e){return(this.query.asCubeQuery().order||{})[e]||"none"},e.prototype.set=function(e){this.query.setPartialQuery({order:e})},e.prototype.asArray=function(){return Array.isArray(this.query.asCubeQuery().order)?this.query.asCubeQuery().order:Object.entries(this.query.asCubeQuery().order||{})},e.prototype.asObject=function(){return this.asArray().reduce((function(e,t){var r,i=p(t,2),n=i[0],s=i[1];return Object.assign(Object.assign({},e),((r={})[n]=s,r))}),{})},e}();var q=function(){function e(e){this.query=e}return Object.defineProperty(e.prototype,"filters",{get:function(){return this.query.asCubeQuery().filters||[]},enumerable:!1,configurable:!0}),e.prototype.update=function(e,t){var r=this.filters.map((function(r,i){return i===e||r.member===e||r.dimension===e?Object.assign(Object.assign({},r),t):r}));this.query.setPartialQuery({filters:r})},e.prototype.add=function(e){this.query.setPartialQuery({filters:y(this.filters,[e])})},e.prototype.remove=function(e){this.query.setPartialQuery({filters:this.filters.filter((function(t,r){return t.member!==e&&t.dimension!==e&&r!==e}))})},e.prototype.set=function(e){this.query.setPartialQuery({filters:e})},e.prototype.replace=function(e,t){this.query.setPartialQuery({filters:this.filters.map((function(r){var i,n=r.member?"member":"dimension";return r.member===e||r.dimension===e?Object.assign(Object.assign({},r),((i={})[n]=t,i)):r}))})},e.prototype.asArray=function(){var e=this;return this.filters.map((function(t){return Object.assign(Object.assign(Object.assign({},e.query.meta.resolveMember(t.member||t.dimension,["dimensions","measures"])),{operators:e.query.meta.filterOperatorsForMember(t.member||t.dimension,["dimensions","measures"])}),t)}))},e}();var O={Measures:"measures",Dimensions:"dimensions",Segments:"segments",TimeDimensions:"timeDimensions",Filters:"filters",Order:"order"},Q=function(e){function t(t,r){void 0===r&&(r=function(e){return e});var i=e.call(this,{})||this;return i.meta=t,i._onBeforeChange=r,i.init(),i}return f(t,e),t.prototype.init=function(){this.measures=new g(this,O.Measures),this.dimensions=new g(this,O.Dimensions),this.segments=new g(this,O.Segments),this.timeDimensions=new v(this),this.filters=new q(this),this.order=new j(this)},t.prototype.asCubeQuery=function(){return this.subject.getValue()||{}},t.prototype.setQuery=function(e){this.subject.next(this._onBeforeChange(e,this.subject.getValue(),this))},t.prototype.setPartialQuery=function(e){this.subject.next(this._onBeforeChange(Object.assign(Object.assign({},this.subject.getValue()),e),this.subject.getValue(),this))},t.prototype.setLimit=function(e){this.setPartialQuery({limit:e})},t.prototype.isPresent=function(){return i.isQueryPresent(this.asCubeQuery())},t}(d);var w=function(){function e(e){this.meta=e,this.mapMeta()}return e.prototype.mapMeta=function(){var e=this,t=this.meta.membersForQuery(null,"dimensions");this.measures=this.meta.membersForQuery(null,"measures"),this.segments=this.meta.membersForQuery(null,"segments"),this.dimensions=t.filter((function(e){return"time"!==e.type})),this.timeDimensions=t.filter((function(e){return"time"===e.type})),this.filters=y(t,this.measures).map((function(t){return Object.assign(Object.assign({},t),{operators:e.meta.filterOperatorsForMember(t.name,["dimensions","measures"])})}))},e}();var C=function(e){function t(t){return e.call(this,t)||this}return f(t,e),t.prototype.moveItem=function(e,t,r,n){this.subject.next(i.movePivotItem(this.get(),e,t,r,n))},t.prototype.setFillMissingDates=function(e){this.subject.next(Object.assign(Object.assign({},this.get()),{fillMissingDates:e}))},t}(d),P=function(e){function t(t){return e.call(this,t)||this}return f(t,e),t}(d),_=function(){function e(){var e=this;this._disableHeuristics=!1,this._heuristicChange$=new r.Subject,this.builderMeta=new Promise((function(t){return e._resolveBuilderMeta=t})),this.query=new Promise((function(t){return e._resolveQuery=t})),this.state=new r.BehaviorSubject({})}return e.prototype.init=function(){return l(this,void 0,void 0,(function(){var e=this;return h(this,(function(t){return this.pivotConfig=new C(null),this.chartType=new P("line"),this._cubejs.meta().subscribe((function(t){e._meta=t,e._query=new Q(e._meta,e._handleQueryChange.bind(e)),e._resolveQuery(e._query),e._resolveBuilderMeta(new w(e._meta))})),this.subscribe(),this._disableHeuristics||this._heuristicChange$.pipe(n.switchMap((function(t){return r.combineLatest([e._cubejs.dryRun(t.query).pipe(n.catchError((function(e){return r.of(null)}))),r.of(t.shouldApplyHeuristicOrder)])}))).subscribe((function(t){var r=p(t,2),n=r[0],s=r[1];if(n){var o=n.pivotQuery,u=n.queryOrder;e.pivotConfig.set(i.ResultSet.getNormalizedPivotConfig(o,e.pivotConfig.get())),s&&e._query.order.set(u.reduce((function(e,t){return Object.assign(Object.assign({},e),t)}),{}))}})),[2]}))}))},e.prototype._handleQueryChange=function(e,t){var r,n,s=i.defaultHeuristics(e,t,{meta:this._meta,sessionGranularity:null===(n=null===(r=null==e?void 0:e.timeDimensions)||void 0===r?void 0:r[0])||void 0===n?void 0:n.granularity}),o=s.chartType,u=s.shouldApplyHeuristicOrder,a=s.query,c=this._disableHeuristics?e:a||e;return i.isQueryPresent(c)&&!this._disableHeuristics&&this._heuristicChange$.next({shouldApplyHeuristicOrder:Boolean(u),query:c}),!this._disableHeuristics&&o&&this.chartType.set(o),c},e.prototype.setCubejsClient=function(e){this._cubejs=e,this.init()},e.prototype.subscribe=function(){var e=this;Object.getOwnPropertyNames(this).forEach((function(t){e[t]instanceof d&&e[t].subject.subscribe((function(r){var i;return e.setPartialState(((i={})[t]=r,i))}))})),this.query.then((function(t){t.subject.subscribe((function(t){e.setPartialState({query:t})}))}))},e.prototype.deserialize=function(e){return l(this,void 0,void 0,(function(){var t=this;return h(this,(function(r){switch(r.label){case 0:return e.query?[4,this.query]:[3,2];case 1:r.sent().setQuery(e.query),r.label=2;case 2:return Object.entries(e).forEach((function(e){var r=p(e,2),i=r[0],n=r[1];t[i]instanceof d&&t[i].set(n)})),this.subscribe(),[2]}}))}))},e.prototype.setPartialState=function(e){this.state.next(Object.assign(Object.assign({},this.state.getValue()),e))},e.prototype.disableHeuristics=function(){this._disableHeuristics=!1},e.prototype.enableHeuristics=function(){this._disableHeuristics=!0},e}();_.decorators=[{type:t.Injectable}],e.BaseMember=g,e.BuilderMeta=w,e.ChartType=P,e.CubejsClient=b,e.CubejsClientModule=m,e.FilterMember=q,e.MemberType=O,e.Order=j,e.PivotConfig=C,e.Query=Q,e.QueryBuilderService=_,e.TimeDimensionMember=v,e["ɵa"]=d,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=cubejs-client-ngx.umd.min.js.map